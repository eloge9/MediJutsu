{% extends "patient/base_patient.html" %}

{% block content %}
<style>
    table {
        border-collapse: collapse;
        width: 100%;
        table-layout: fixed;
    }

    th,
    td {
        border: 1px solid #ccc;
        vertical-align: top;
        padding: 5px;
        height: 100px;
    }

    th {
        background-color: #f0f0f0;
    }

    .event {
        padding: 2px 4px;
        margin: 2px 0;
        border-radius: 4px;
        color: white;
        font-size: 12px;
    }

    /* Couleurs selon le statut */
    .confirmé {
        background-color: #3788d8;
        /* bleu */
    }

    .en-attente {
        background-color: #f0ad4e;
        /* jaune/orange */
    }

    .annulé {
        background-color: #d9534f;
        /* rouge */
    }

    .terminé {
        background-color: #5cb85c;
        /* vert */
    }

    .other-month {
        color: #aaa;
    }

    .event:hover {
        opacity: 0.8;
        cursor: pointer;
    }
</style>
<div class="app-container">
    <div class="app-hero-header d-flex align-items-center mb-4">
        <ol class="breadcrumb mb-0">
            <li class="breadcrumb-item">
                <i class="ri-home-8-line lh-1 pe-3 me-3 border-end"></i>
                <a href="{{ url_for('index_patient') }}">Patient</a>
            </li>
            <li class="breadcrumb-item text-primary" aria-current="page">
                Calendrier rendez-vous
            </li>
        </ol>
    </div>
    <div class="app-body">

        <!-- Row starts -->
        <div class="row gx-3">
            <div class="col-sm-12 col-12">
                <div class="card">
                    <div class="card-header d-flex align-items-center justify-content-between">
                        <h3 class="card-title">Calendrier des rendez-vous</h3>
                        <a href="{{ url_for('nouveau_rendezvous') }}" class="btn btn-primary ms-auto">Prendre
                            Rendez-vous</a>
                    </div>
                    <div class="card-body">

                        <div style="margin-bottom: 10px;">
                            <button onclick="prevMonth()">← Mois précédent</button>
                            <span id="month-year" style="font-weight: bold; margin: 0 10px;"></span>
                            <button onclick="nextMonth()">Mois suivant →</button>

                        </div>

                        <table>
                            <thead>
                                <tr>
                                    <th>Lundi</th>
                                    <th>Mardi</th>
                                    <th>Mercredi</th>
                                    <th>Jeudi</th>
                                    <th>Vendredi</th>
                                    <th>Samedi</th>
                                    <th>Dimanche</th>
                                </tr>
                            </thead>
                            <tbody id="calendar-body"></tbody>


                        </table>

                        <style>
                            table {
                                border-collapse: collapse;
                                width: 100%;
                                table-layout: fixed;
                            }

                            th,
                            td {
                                border: 1px solid #ccc;
                                vertical-align: top;
                                padding: 5px;
                                height: 100px;
                            }

                            th {
                                background-color: #f0f0f0;
                            }

                            .event {
                                padding: 2px 4px;
                                margin: 2px 0;
                                border-radius: 4px;
                                color: white;
                                font-size: 12px;
                            }

                            .confirmé {
                                background-color: #3788d8;
                            }

                            .en-attente {
                                background-color: #f0ad4e;
                            }

                            .other-month {
                                color: #aaa;
                            }

                            /* gris pour les jours hors mois */
                            .event:hover {
                                opacity: 0.8;
                                cursor: pointer;
                            }
                        </style>

                        <script>
                            const events = {{ events| tojson | safe }}; // tes rendez-vous Flask
                            let currentDate = new Date();

                            // Noms des mois
                            const monthNames = [
                                "Janvier", "Février", "Mars", "Avril", "Mai", "Juin",
                                "Juillet", "Août", "Septembre", "Octobre", "Novembre", "Décembre"
                            ];

                            // Construire le calendrier
                            function buildCalendar() {
                                document.getElementById('month-year').textContent = monthNames[currentDate.getMonth()] + " " + currentDate.getFullYear();

                                const tbody = document.getElementById('calendar-body');
                                tbody.innerHTML = '';

                                const year = currentDate.getFullYear();
                                const month = currentDate.getMonth();

                                const firstDay = new Date(year, month, 1).getDay(); // 0 = dimanche
                                const daysInMonth = new Date(year, month + 1, 0).getDate();

                                let row = document.createElement('tr');
                                let dayCount = 1;

                                // Décalage pour le premier jour
                                for (let i = 0; i < (firstDay === 0 ? 6 : firstDay - 1); i++) {
                                    const cell = document.createElement('td');
                                    cell.classList.add('other-month');
                                    cell.textContent = '';
                                    row.appendChild(cell);
                                }

                                for (let i = (firstDay === 0 ? 6 : firstDay - 1); i < 7; i++) {
                                    addDayCell(row, dayCount, year, month);
                                    dayCount++;
                                }
                                tbody.appendChild(row);

                                while (dayCount <= daysInMonth) {
                                    row = document.createElement('tr');
                                    for (let i = 0; i < 7; i++) {
                                        if (dayCount > daysInMonth) break;
                                        addDayCell(row, dayCount, year, month);
                                        dayCount++;
                                    }
                                    tbody.appendChild(row);
                                }
                            }

                            // Ajouter une cellule de jour
                            function addDayCell(row, day, year, month) {
                                const cell = document.createElement('td');
                                cell.textContent = day;
                                const dayStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;

                                events.filter(e => e.date === dayStr).forEach(e => {
                                    const div = document.createElement('div');
                                    div.textContent = `${e.title} (${e.time})`;

                                    // Appliquer la classe selon le statut
                                    switch (e.statut.toLowerCase()) {
                                        case 'confirmé':
                                            div.className = 'event confirmé';
                                            break;
                                        case 'en attente':
                                            div.className = 'event en-attente';
                                            break;
                                        case 'annulé':
                                            div.className = 'event annulé';
                                            break;
                                        case 'terminé':
                                            div.className = 'event terminé';
                                            break;
                                        default:
                                            div.className = 'event';
                                    }

                                    if (e.url) {
                                        div.onclick = () => { window.location.href = e.url; };
                                    }
                                    cell.appendChild(div);
                                });

                                row.appendChild(cell);
                            }


                            // Navigation mois
                            function prevMonth() {
                                currentDate.setMonth(currentDate.getMonth() - 1);
                                buildCalendar();
                            }

                            function nextMonth() {
                                currentDate.setMonth(currentDate.getMonth() + 1);
                                buildCalendar();
                            }

                            buildCalendar();
                        </script>
                        <a href="{{ url_for('nouveau_rendezvous') }}" class="btn btn-secondary">
                            <i class="bi bi-arrow-left"></i> Prendre rendez-vous
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}