{% extends "patient/base_patient.html" %}

{% block content %}
<div class="app-hero-header d-flex align-items-center mb-4">
    <ol class="breadcrumb mb-0">
        <li class="breadcrumb-item">
            <i class="ri-home-8-line lh-1 pe-3 me-3 border-end"></i>
            <a href="{{ url_for('index_patient') }}">Patient</a>
        </li>
        <li class="breadcrumb-item text-primary" aria-current="page">
            Dossier Médical
        </li>
    </ol>
</div>
<div class="container mt-4">
    <h2 class="mb-4">Dossier Médical - {{ patient.nom_complet }}</h2>

    <!-- Onglets -->
    <ul class="nav nav-tabs" id="dossierTab" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="profil-tab" data-bs-toggle="tab" data-bs-target="#profil" type="button"
                role="tab">Profil</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="consultations-tab" data-bs-toggle="tab" data-bs-target="#consultations"
                type="button" role="tab">Consultations</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="rendezvous-tab" data-bs-toggle="tab" data-bs-target="#rendezvous" type="button"
                role="tab">Rendez-vous</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="admissions-tab" data-bs-toggle="tab" data-bs-target="#admissions" type="button"
                role="tab">Admissions / Sorties</button>
        </li>
    </ul>

    <!-- Contenu des onglets -->
    <div class="tab-content p-3 border border-top-0" id="dossierTabContent">

        <!-- Profil -->
        <div class="tab-pane fade show active" id="profil" role="tabpanel">
            <h5>Informations du patient</h5>
            <p><strong>Nom complet :</strong> {{ patient.nom_complet }}</p>
            <p><strong>Email :</strong> {{ patient.email_patient }}</p>
            <p><strong>Date de naissance :</strong> {{ patient.date_naissance }}</p>
            <p><strong>Adresse :</strong> {{ patient.adresse }}</p>
            <p><strong>Téléphone :</strong> {{ patient.numero_telephone }}</p>
            <p><strong>Sexe :</strong> {{ patient.sexe }}</p>
            <p><strong>Groupe sanguin :</strong> {{ patient.groupe_sanguin }}</p>
            <p><strong>Profession :</strong> {{ patient.profession }}</p>
        </div>

        <!-- Consultations -->
        <div class="tab-pane fade" id="consultations" role="tabpanel">
            <h5>Historique des consultations</h5>
            {% if consultations %}
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Médecin</th>
                        <th>Diagnostic</th>
                        <th>Prescription</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for c in consultations %}
                    <tr>
                        <td>{{ c.date_consultation.strftime('%d/%m/%Y') }}</td>
                        <td>{{ c.doctor.nom_complet }}</td>
                        <td>{{ c.diagnostic }}</td>
                        <td>{{ c.prescription }}</td>
                        <td>
                            <a href="{{ url_for('voir_consultation_patient', id=c.id) }}"
                                class="btn btn-sm btn-primary">Voir détails</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p>Aucune consultation enregistrée.</p>
            {% endif %}
        </div>

        <!-- Rendez-vous -->
        <div class="tab-pane fade" id="rendezvous" role="tabpanel">
            <h5>Rendez-vous</h5>
            {% if rendezvous %}
            <ul class="list-group">
                {% for r in rendezvous %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    {{ r.date_rdv.strftime('%d/%m/%Y') }} à {{ r.heure_debut.strftime('%H:%M') }}
                    {% if r.doctor %}avec Dr {{ r.doctor.nom_complet }}{% else %} - Médecin non assigné{% endif %}
                    <a href="{{ url_for('detail_rendezvous', id=r.id) }}" class="btn btn-sm btn-info ms-3">Voir
                        détails</a>
                </li>
                {% endfor %}
            </ul>
            {% else %}
            <p>Aucun rendez-vous enregistré.</p>
            {% endif %}
        </div>

        <!-- Admissions / Sorties -->
        <div class="tab-pane fade" id="admissions" role="tabpanel">
            <h5>Admissions & Sorties</h5>
            {% if admissions %}
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th>Date d’admission</th>
                        <th>Motif</th>
                        <th>Date de sortie</th>
                        <th>Observations</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for a in admissions %}
                    <tr>
                        <td>{{ a.date_admission.strftime('%d/%m/%Y') }}</td>
                        <td>{{ a.motif }}</td>
                        <td>
                            {% set s = sorties|selectattr('admission_id','equalto',a.ident)|first %}
                            {% if s %}
                            {{ s.date_sortie.strftime('%d/%m/%Y') }}
                            {% else %}
                            En cours
                            {% endif %}
                        </td>
                        <td>{{ a.observations or '-' }}</td>
                        <td>
                            <a href="{{ url_for('voir_admission_patient', admission_id=a.ident) }}"
                                class="btn btn-sm btn-success">Voir admission</a>
                            {% if s %}
                            <a href="{{ url_for('voir_sortie_patient', sortie_id=s.ident) }}"
                                class="btn btn-sm btn-warning">Voir sortie</a>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <p>Aucune admission enregistrée.</p>
            {% endif %}
        </div>


    </div>
</div>
{% endblock %}