{% extends "secretaire_medicales/base_secretaire_medicales.html" %}

{% block content %}
<div class="app-container">

  <!-- üü¶ HEADER -->
  <div class="app-hero-header d-flex align-items-center justify-content-between mb-4">
    <!-- Fil d‚ÄôAriane -->
    <ol class="breadcrumb mb-0">
      <li class="breadcrumb-item">
        <i class="ri-home-8-line me-2"></i>
        <a href="/secretaire_medicales">Secr√©taire m√©dicales</a>
      </li>
      <li class="breadcrumb-item text-primary" aria-current="page">Tableau de bord</li>
    </ol>

    <!-- Filtres p√©riode -->
    <div class="d-none d-lg-flex gap-2">
      {% for label in ["Aujourd'hui", "7 jours", "2 semaines", "1 mois", "3 mois", "6 mois", "1 an"] %}
      <button class="btn btn-sm {% if loop.first %}btn-primary{% else %}btn-outline-secondary{% endif %}">
        {{ label }}
      </button>
      {% endfor %}
    </div>
  </div>

  <!-- üü© WIDGETS STATISTIQUES -->
  <div class="container-fluid">

    <!-- üìä Ligne principale : Widget + activit√© + courbe -->
    <div class="row gx-3 mb-4">

      <!-- 1Ô∏è‚É£ Widget principal avec stats -->
      <div class="col-xxl-6 col-lg-12 mb-3">
        <div class="card shadow-lg border-0 bg-primary text-white rounded-3 h-100">
          <div class="card-body d-flex align-items-center p-4">
            <!-- Image -->
            <img src="{{ url_for('static', filename='images/doctor.svg') }}" alt="Secr√©taire" class="me-3"
              style="max-width:120px; object-fit:contain;">
            <!-- Texte + stats -->
            <div class="flex-grow-1">
              <h6 class="mb-1 fw-light">Bonjour üëã</h6>
              <h4 class="fw-bold mb-1">{{ session.get('nom_complet') or 'Secr√©taire' }}</h4>
              <p class="mb-3 fs-6">Voici votre tableau de bord</p>
              <div class="row text-center">
                <div class="col-6 col-md-4 mb-2">
                  <div class="icon-box bg-arctic rounded-2 mb-1"><i class="ri-calendar-line fs-4"></i></div>
                  <h5 class="fw-bold mb-0">{{ total_rdv_today }}</h5>
                  <small>Rendez-vous</small>
                </div>
                <div class="col-6 col-md-4 mb-2">
                  <div class="icon-box bg-lime rounded-2 mb-1"><i class="ri-hospital-line fs-4"></i></div>
                  <h5 class="fw-bold mb-0">{{ total_admissions }}</h5>
                  <small>Admissions</small>
                </div>
                <div class="col-6 col-md-4 mb-2">
                  <div class="icon-box bg-orange rounded-2 mb-1"><i class="ri-door-line fs-4"></i></div>
                  <h5 class="fw-bold mb-0">{{ total_sorties }}</h5>
                  <small>Sorties</small>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- 2Ô∏è‚É£ Widget activit√© -->
      <div class="col-xxl-3 col-lg-6 col-sm-12 mb-3">
        <div class="card shadow-sm border-0 bg-lime text-white rounded-3 h-100">
          <div class="card-body text-center p-4">
            <h5 class="fw-bold">üìä Activit√©</h5>
            <div class="display-5 fw-bold">{{ patients_this_week }}</div>
            <small>nouveaux patients cette semaine</small>
            <div class="mt-2">
              {% if pourcentage >= 0 %}
              <span class="badge bg-success fs-6">+{{ pourcentage }}%</span>
              {% else %}
              <span class="badge bg-danger fs-6">{{ pourcentage }}%</span>
              {% endif %}
              <p class="mt-1 mb-0 fs-7">Par rapport √† la semaine derni√®re ({{ patients_last_week }})</p>
            </div>
          </div>
        </div>
      </div>

      <!-- 3Ô∏è‚É£ Carte courbe -->
      <div class="col-xxl-3 col-lg-6 col-sm-12 mb-3">
        <div class="card shadow-sm border-0 rounded-3 h-100 p-3">
          <canvas id="rdvCourbe" style="height:250px;"></canvas>
        </div>
      </div>
    </div>

    <!-- üìã Tables : Rendez-vous, Admissions, Sorties -->
    <div class="row gx-3">

      <!-- Rendez-vous -->
      <div class="col-12 mb-3">
        <div class="card shadow-sm border-0 rounded-3">
          <div class="card-header bg-light">
            <h5 class="mb-0">üìÖ Rendez-vous √† venir</h5>
          </div>
          <div class="card-body table-responsive">
            <table class="table table-hover align-middle">
              <thead class="table-primary">
                <tr>
                  <th>#</th>
                  <th>Patient</th>
                  <th>Docteur</th>
                  <th>Date</th>
                  <th>Heure</th>
                  <th>Statut</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for rdv in rendezvous %}
                <tr>
                  <td>{{ loop.index }}</td>
                  <td>{{ rdv.patient.nom_complet }}</td>
                  <td>{{ rdv.doctor.nom_complet if rdv.doctor else 'Non attribu√©' }}</td>
                  <td>{{ rdv.date_rdv.strftime('%d/%m/%Y') }}</td>
                  <td>{{ rdv.heure_debut.strftime('%H:%M') }} - {{ rdv.heure_fin.strftime('%H:%M') }}</td>
                  <td><span class="badge bg-info">{{ rdv.statut }}</span></td>
                  <td>
                    <a href="{{ url_for('confirmer_rendezvous', rdv_id=rdv.id) }}" class="btn btn-success btn-sm"><i
                        class="ri-check-line"></i></a>
                    <a href="{{ url_for('annuler_rendezvous', rendezvous_id=rdv.id) }}" class="btn btn-danger btn-sm"><i
                        class="ri-close-line"></i></a>
                  </td>
                </tr>
                {% else %}
                <tr>
                  <td colspan="7" class="text-center text-muted">Aucun rendez-vous √† venir</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Admissions -->
      <div class="col-12 col-xxl-6 mb-3">
        <div class="card shadow-sm border-0 rounded-3">
          <div class="card-header bg-light">
            <h5 class="mb-0">üè• Admissions r√©centes</h5>
          </div>
          <div class="card-body table-responsive">
            <table class="table table-hover align-middle">
              <thead class="table-success">
                <tr>
                  <th>#</th>
                  <th>Nom</th>
                  <th>Motif</th>
                  <th>Date</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for adm in admissions %}
                <tr>
                  <td>{{ loop.index }}</td>
                  <td>{{ adm.nom }} {{ adm.prenom }}</td>
                  <td>{{ adm.motif }}</td>
                  <td>{{ adm.date_admission.strftime('%d/%m/%Y') }}</td>
                  <td>
                    <a href="{{ url_for('voir_admission', admission_id=adm.ident) }}" class="btn btn-info btn-sm"><i
                        class="ri-eye-line"></i></a>
                  </td>
                </tr>
                {% else %}
                <tr>
                  <td colspan="5" class="text-center text-muted">Aucune admission r√©cente</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Sorties -->
      <div class="col-12 col-xxl-6 mb-3">
        <div class="card shadow-sm border-0 rounded-3">
          <div class="card-header bg-light">
            <h5 class="mb-0">üö™ Sorties r√©centes</h5>
          </div>
          <div class="card-body table-responsive">
            <table class="table table-hover align-middle">
              <thead class="table-warning">
                <tr>
                  <th>#</th>
                  <th>Nom</th>
                  <th>Motif</th>
                  <th>Date sortie</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for sortie in sorties %}
                <tr>
                  <td>{{ loop.index }}</td>
                  <td>{{ sortie.nom }} {{ sortie.prenom }}</td>
                  <td>{{ sortie.motif }}</td>
                  <td>{{ sortie.date_sortie.strftime('%d/%m/%Y') }}</td>
                  <td>
                    <a href="{{ url_for('voir_sortie', sortie_id=sortie.ident) }}"
                      class="btn btn-outline-info btn-sm"><i class="ri-eye-line"></i></a>
                  </td>
                </tr>
                {% else %}
                <tr>
                  <td colspan="5" class="text-center text-muted">Aucune sortie r√©cente</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>

    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const ctx = document.getElementById('rdvCourbe').getContext('2d');
    const rdvCourbe = new Chart(ctx, {
      type: 'line',
      data: {
        labels: {{ labels | tojson }},
    datasets: [{
      label: 'Nombre de rendez-vous',
      data: {{ data | tojson }},
      borderColor: 'rgba(75, 192, 192, 1)',
      backgroundColor: 'rgba(75, 192, 192, 0.2)',
      tension: 0.3,
      fill: true,
      pointBackgroundColor: 'rgba(75, 192, 192, 1)',
      pointBorderWidth: 2,
      pointRadius: 4
      }]
    },
    options: {
      responsive: true,
        plugins: {
        legend: { display: true, position: 'top' },
        title: { display: true, text: '√âvolution des rendez-vous cette semaine', font: { size: 14 } }
      },
      scales: {
        x: { title: { display: true, text: 'Jour' } },
        y: { beginAtZero: true, title: { display: true, text: 'Rendez-vous' }, ticks: { stepSize: 1 } }
      }
    }
  });
  </script>

</div>
{% endblock %}